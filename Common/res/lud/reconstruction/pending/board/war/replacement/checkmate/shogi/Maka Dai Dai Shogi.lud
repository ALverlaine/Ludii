(define "CapturePiece"
    (apply 
        (if ("IsEnemyAt" (to))
            (add 
                (piece (mapEntry "Captured" (what at:(to)))) 
                (to (mapEntry "Where" (what at:(to))))
            )
        )
    )
)

(define "NextCannotMove"
    (not 
        (can Move 
            (do 
                (forEach Piece Next) 
                ifAfterwards:(not ("IsInCheck" "Lance" Next))
            ) 
        )
    )
)

(define "InPromotionZone"
    (is In #1 (sites Mover "Promotion"))	
)

(define "Promote"
    (move Promote (last To) (piece (mapEntry "Promoted" (what at:(last To)))))	
)

(define "CanPromote"
	    (then 
	        (if 
	            (or ("InPromotionZone" (last To)) ("InPromotionZone" (last From))) 
	            (moveAgain) 
	        ) 
	    )
	)

(define "SlideMove"
    (move Slide
        #1 
        #3 
        (to if:("IsEnemyAt" (to)) "CapturePiece")
        #2 
    ) 	
)

(define "StepMove"
    (move Step
        #1
        (to if:(not ("IsFriendAt" (to))) "CapturePiece") 
        #2 
    ) 	
)

(define "HopMove" 
    (move Hop
        #1
        (between 
            if:True
        )
        (to 
            if:(not ("IsFriendAt" (to))) 
            (apply (if ("IsEnemyAt" (to)) (remove (to))))
        ) 
        #2 
    )
)

//------------------------------------------------------------------------------


(game "Maka Dai Dai Shogi"
    <Variant>
)

//------------------------------------------------------------------------------

(option "Variant" <Variant> args:{ <variant> }
    {
    (item "Incomplete"
        <
        ("TwoPlayersNorthSouth") 
        (equipment { 
            (board (square 19))

            (regions "Promotion" P1 (expand (sites Top) steps:2))
            (regions "Promotion" P2 (expand (sites Bottom) steps:2))

            // Kyosha
            (piece "Lance" Each ("SlideMove" Forward "CanPromote"))
            
            (map "Promoted" { 
                //(pair (id "Lance" P1) (id "WhiteHorse" P1)) (pair (id "Lance" P2) (id "WhiteHorse" P2)) 
            })
        })
        (rules
            (start {
            	(place "Lance1" {"A1" "S1"}) 
                (place "Lance2" {"A19" "S19"})
            })
            (play
                    (if ("SameTurn")
//                        (if (and (is Pending) (is In (what at:(last To)) (sites {(id "Lion" Mover)})))
//                            (forEach Piece {"Lion"}
//                                (or
//                                    ("HopMove" (directions All))
//                                    ("StepMove" (directions All))
//                                )
//                            ) 
                            (or
                                ("Promote")
                                (move Pass)
                            )
                       // )
                        (do 
                            (forEach Piece) 
                            ifAfterwards:(not ("IsInCheck" "Lance" Mover))
                        )
                    )
                )
            (end {
                (if (and 
                        ("IsInCheck" "Lance" Next)
                        ("NextCannotMove")
                    ) 
                    (result Mover Win)
                ) 
            })
        )
        >
        "The incomplete ruleset."
    )
})

//------------------------------------------------------------------------------

(rulesets { 
    
    (ruleset "Ruleset/Historical Information (Incomplete)" {
        "Variant/Incomplete"
    })
    
})

//------------------------------------------------------------------------------

(metadata 
    
    (info
        {
        (description "Maka Dai Dai Shogi is a large version of Shogi played in the Edo period.")
        (rules "19x19 board. 192 pieces.")
        (source "DLP evidence.")
        (id "1338")
        (version "1.3.9")
        (classification "board/war/replacement/checkmate/shogi/reconstruction/pending")
        (credit "Eric Piette")
        }
    )
    
    (graphics {
        (player Colour P1 (colour White))
        (player Colour P2 (colour White))
        (piece Rotate P2 degrees:180)
        (board Style Shogi)
        (piece Style ExtendedShogi)
    })
    
)
