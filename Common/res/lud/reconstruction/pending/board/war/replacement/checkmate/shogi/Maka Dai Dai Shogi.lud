(define "CapturePiece"
    (apply 
        (if ("IsEnemyAt" (to))
            (add 
                (piece (mapEntry "Captured" (what at:(to)))) 
                (to (mapEntry "Where" (what at:(to))))
            )
        )
    )
)

(define "NextCannotMove"
    (not 
        (can Move 
            (do 
                (forEach Piece Next) 
                ifAfterwards:(not ("IsInCheck" "Osho" Next))
            ) 
        )
    )
)

(define "InPromotionZone"
    (is In #1 (sites Mover "Promotion"))	
)

(define "Promote"
    (move Promote (last To) (piece (mapEntry "Promoted" (what at:(last To)))))	
)

(define "CanPromote"
	    (then 
	        (if 
	            (or ("InPromotionZone" (last To)) ("InPromotionZone" (last From))) 
	            (moveAgain) 
	        ) 
	    )
	)

(define "SlideMove"
    (move Slide
        #1 
        #3 
        (to if:("IsEnemyAt" (to)) "CapturePiece")
        #2 
    ) 	
)

(define "StepMove"
    (move Step
        #1
        (to if:(not ("IsFriendAt" (to))) "CapturePiece") 
        #2 
    ) 	
)

(define "HopMove" 
    (move Hop
        #1
        (between 
            if:True
        )
        (to 
            if:(not ("IsFriendAt" (to))) 
            (apply (if ("IsEnemyAt" (to)) (remove (to))))
        ) 
        #2 
    )
)

//------------------------------------------------------------------------------


(game "Maka Dai Dai Shogi"
    <Variant>
)

//------------------------------------------------------------------------------

(option "Variant" <Variant> args:{ <variant> }
    {
    (item "Incomplete"
        <
        ("TwoPlayersNorthSouth") 
        (equipment { 
            (board (square 19))

            (regions "Promotion" P1 (expand (sites Top) steps:2))
            (regions "Promotion" P2 (expand (sites Bottom) steps:2))

            // Kyosha
            (piece "Lance" Each ("SlideMove" Forward))
            // Dosho
            (piece "EarthGeneral" Each ("StepMove" (directions {Forward Backward}) "CanPromote"))
            // Honnin
            (piece "FreeGoer" Each ("SlideMove" (directions {Forward BR BL})))
            // Sekisho
            (piece "StoneGeneral" Each ("StepMove" (directions {FR FL}) "CanPromote"))
            // Honseki
            (piece "FreeStone" Each ("SlideMove" (directions {FR FL})))
            // Gacho
            (piece "TileGeneral" Each ("StepMove" (directions {FR FL Backward}) "CanPromote"))
            // Honga
            (piece "FreeTile" Each ("SlideMove" (directions {FR FL Backward})))
            // Techo
            (piece "IronGeneral" Each ("StepMove" (directions {Forward FR FL}) "CanPromote"))
            // Hontetsu
            (piece "FreeIron" Each ("SlideMove" (directions {Forward FR FL})))
            // Dosho (second one)
            (piece "CopperGeneral" Each ("StepMove" (directions {Forward FR FL Backward}) "CanPromote"))
            // Hondo
            (piece "FreeCopper" Each ("SlideMove" (directions {Forward FR FL Backward})))
            // Ginsho
            (piece "SilverGeneral" Each ("StepMove" (directions {Forward Backward FR FL BR BL}) "CanPromote"))
            // Hondo
            (piece "FreeSilver" Each ("SlideMove" (directions {Forward Backward FR FL BR BL})))
            // Kinsho
            (piece "GoldGeneral" Each ("StepMove" (directions {Forward Backward Leftward Rightward BR BL}) "CanPromote"))
            // Honkin
            (piece "FreeGold" Each ("SlideMove" (directions {Forward Backward Leftward Rightward BR BL})))
            // Deva
            (piece "Deva" Each ("StepMove" (directions {FR FL Leftward BL}) "CanPromote"))
            // Kyoo
            (piece "TeachingKing" Each ("SlideMove" (directions {FR FL Leftward BR}))) // TO REPLACE THIS BY [#]
            // Mumyo
            (piece "DarkSpirit" Each ("StepMove" (directions {FR FL Rightward BR}) "CanPromote"))
            // Hosei
            (piece "BuddhistSpirit" Each ("SlideMove" (directions {FR FL Leftward BR}))) // TO REPLACE THIS BY [#]
            // King
            (piece "Osho" Each ("StepMove" All "CanPromote"))
            // Tenno
            (piece "Emperor" Each 
                    (and
                            (do
                                (move 
                                    (from)
                                    (to (sites Occupied by:Enemy))
                                )
                                ifAfterwards:(not ("IsInCheck" "Emperor" Mover))
                            )
                            (move 
                                (from)
                                (to (sites Empty))
                            )
                        )			
            )
            
            (map "Promoted" { 
                (pair (id "EarthGeneral" P1) (id "FreeGoer" P1)) (pair (id "EarthGeneral" P2) (id "FreeGoer" P2)) 
                (pair (id "StoneGeneral" P1) (id "FreeStone" P1)) (pair (id "StoneGeneral" P2) (id "FreeStone" P2)) 
                (pair (id "TileGeneral" P1) (id "FreeTile" P1)) (pair (id "TileGeneral" P2) (id "FreeTile" P2)) 
                (pair (id "IronGeneral" P1) (id "FreeIron" P1)) (pair (id "IronGeneral" P2) (id "FreeIron" P2)) 
                (pair (id "CopperGeneral" P1) (id "FreeCopper" P1)) (pair (id "CopperGeneral" P2) (id "FreeCopper" P2)) 
                (pair (id "SilverGeneral" P1) (id "FreeSilver" P1)) (pair (id "SilverGeneral" P2) (id "FreeSilver" P2)) 
                (pair (id "GoldGeneral" P1) (id "FreeGold" P1)) (pair (id "GoldGeneral" P2) (id "FreeGold" P2)) 
                (pair (id "Deva" P1) (id "TeachingKing" P1)) (pair (id "Deva" P2) (id "TeachingKing" P2)) 
                (pair (id "DarkSpirit" P1) (id "BuddhistSpirit" P1)) (pair (id "DarkSpirit" P2) (id "BuddhistSpirit" P2)) 
                (pair (id "Osho" P1) (id "Emperor" P1)) (pair (id "Osho" P2) (id "Emperor" P2)) 
            })
        })
        (rules
            (start {
            	(place "Lance1" {"A1" "S1"}) 
                (place "Lance2" {"A19" "S19"})
            	(place "EarthGeneral1" {"B1" "R1"}) 
                (place "EarthGeneral2" {"B19" "R19"})
            	(place "StoneGeneral1" {"C1" "Q1"}) 
                (place "StoneGeneral2" {"C19" "Q19"})
            	(place "TileGeneral1" {"D1" "P1"}) 
                (place "TileGeneral2" {"D19" "P19"})
            	(place "IronGeneral1" {"E1" "O1"}) 
                (place "IronGeneral2" {"E19" "O19"})
            	(place "CopperGeneral1" {"F1" "N1"}) 
                (place "CopperGeneral2" {"F19" "N19"})
            	(place "SilverGeneral1" {"G1" "M1"}) 
                (place "SilverGeneral2" {"G19" "M19"})
            	(place "GoldGeneral1" {"H1" "L1"}) 
                (place "GoldGeneral2" {"H19" "L19"})
            	(place "Deva1" {"I1"}) 
                (place "Deva2" {"K19"})
            	(place "DarkSpirit1" {"K1"}) 
                (place "DarkSpirit2" {"I19"})
            	(place "Osho1" {"J1"}) 
                (place "Osho2" {"J19"})
            })
            (play
                    (if ("SameTurn")
//                        (if (and (is Pending) (is In (what at:(last To)) (sites {(id "Lion" Mover)})))
//                            (forEach Piece {"Lion"}
//                                (or
//                                    ("HopMove" (directions All))
//                                    ("StepMove" (directions All))
//                                )
//                            ) 
                            (or
                                ("Promote")
                                (move Pass)
                            )
                       // )
                        (do 
                            (forEach Piece) 
                            ifAfterwards:(not ("IsInCheck" "Osho" Mover))
                        )
                    )
                )
            (end {
                (if (and 
                        ("IsInCheck" "Osho" Next)
                        ("NextCannotMove")
                    ) 
                    (result Mover Win)
                ) 
            })
        )
        >
        "The incomplete ruleset."
    )
})

//------------------------------------------------------------------------------

(rulesets { 
    
    (ruleset "Ruleset/Historical Information (Incomplete)" {
        "Variant/Incomplete"
    })
    
})

//------------------------------------------------------------------------------

(metadata 
    
    (info
        {
        (description "Maka Dai Dai Shogi is a large version of Shogi played in the Edo period.")
        (rules "19x19 board. 192 pieces.")
        (source "DLP evidence.")
        (id "1338")
        (version "1.3.9")
        (classification "board/war/replacement/checkmate/shogi/reconstruction/pending")
        (credit "Eric Piette")
        }
    )
    
    (graphics {
        (player Colour P1 (colour White))
        (player Colour P2 (colour White))
        (piece Rotate P2 degrees:180)
        (board Style Shogi)
        (piece Style ExtendedShogi)
    })
    
)
