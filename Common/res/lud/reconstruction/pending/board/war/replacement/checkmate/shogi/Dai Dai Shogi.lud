(define "CapturePiece"
    (apply 
        (if ("IsEnemyAt" (to))
            (add 
                (piece (mapEntry "Captured" (what at:(to)))) 
                (to (mapEntry "Where" (what at:(to))))
            )
        )
    )
)

(define "NextCannotMove"
    (not 
        (can Move 
            (do 
                (forEach Piece Next) 
                ifAfterwards:(not ("IsInCheck" "Lance" Next))
            ) 
        )
    )
)

(define "InPromotionZone"
    (is In #1 (sites Mover "Promotion"))	
)

(define "Promote"
    (move Promote (last To) (piece (mapEntry "Promoted" (what at:(last To)))))	
)

(define "CanPromote"
	    (then 
	        (if 
	            (or ("InPromotionZone" (last To)) ("InPromotionZone" (last From))) // to change to #
	            (moveAgain) 
	        ) 
	    )
	)

(define "SlideMove"
    (move Slide
        #1 
        #3 
        (to if:("IsEnemyAt" (to)) "CapturePiece")
        #2 
    ) 	
)

(define "StepMove"
    (move Step
        #1
        (to if:(not ("IsFriendAt" (to))) "CapturePiece") 
        #2 
    ) 	
)

(define "HopMove" 
    (move Hop
        #1
        (between 
            if:True
        )
        (to 
            if:(not ("IsFriendAt" (to))) 
            (apply (if ("IsEnemyAt" (to)) (remove (to))))
        ) 
        #2 
    )
)

//------------------------------------------------------------------------------

(game "Dai Dai Shogi"
    <Variant>
)

//------------------------------------------------------------------------------

(option "Variant" <Variant> args:{ <variant> }
    {
    (item "Incomplete"
        <
        ("TwoPlayersNorthSouth") 
        (equipment { 
            (board (square 17))

            (regions "Promotion" P1 (expand (sites Top) steps:2))
            (regions "Promotion" P2 (expand (sites Bottom) steps:2))

            // Kyosha
            (piece "Lance" Each ("SlideMove" Forward "CanPromote"))
            // Hakku
            (piece "WhiteHorse" Each ("SlideMove" (directions {Forward Backward FR FL})))
            
            (map "Promoted" { 
                (pair (id "Lance" P1) (id "WhiteHorse" P1)) (pair (id "Lance" P2) (id "WhiteHorse" P2)) 
//                (pair (id "Knight" P1) (id "GoldGeneral" P1)) (pair (id "Knight" P2) (id "GoldGeneral" P2)) 
//                (pair (id "StoneGeneral" P1) (id [#])) (pair (id "StoneGeneral" P2) (id [#])) 
//                (pair (id "IronGeneral" P1) (id [#])) (pair (id "IronGeneral" P2) (id [#]))
//                (pair (id "LongBowGeneral" P1) (id "SideMover" P1)) (pair (id "LongBowGeneral" P2) (id "SideMover" P2)) 
//                (pair (id "SilverGeneral" P1) (id "VerticalMover" P1)) (pair (id "SilverGeneral" P2) (id "VerticalMover" P2)) 
//                (pair (id "GoldGeneral" P1) (id "Rook" P1)) (pair (id "GoldGeneral" P2) (id "Rook" P2)) 
//                (pair (id "ReverseChariot" P1) (id "Whale" P1)) (pair (id "ReverseChariot" P2) (id "Whale" P2)) 
//                (pair (id "CatSword" P1) (id [#])) (pair (id "CatSword" P2) (id [#])) 
//                (pair (id "FerociousLeopard" P1) (id "Bishop" P1)) (pair (id "FerociousLeopard" P2) (id "Bishop" P2)) 
//                (pair (id "BlindTiger" P1) (id "FlyingStag" P1)) (pair (id "BlindTiger" P2) (id "FlyingStag" P2)) 
//                (pair (id "Suizo" P1) (id "Prince" P1)) (pair (id "Suizo" P2) (id "Prince" P2)) 
//                (pair (id "ViolentOx" P1) (id [#])) (pair (id "ViolentOx" P2) (id [#])) 
//                (pair (id "AngryBoar" P1) (id [#])) (pair (id "AngryBoar" P2) (id [#])) 
//                (pair (id "EvilWolf" P1) (id [#])) (pair (id "EvilWolf" P2) (id [#])) 
//                (pair (id "Kirin" P1) (id "Lion" P1)) (pair (id "Kirin" P2) (id "Lion" P2)) 
//                (pair (id "Phenix" P1) (id "Queen" P1)) (pair (id "Phenix" P2) (id "Queen" P2)) 
//                (pair (id "Rook" P1) (id "DragonKing" P1)) (pair (id "Rook" P2) (id "DragonKing" P2)) 
//                (pair (id "FlyingDragon" P1) (id [#])) (pair (id "FlyingDragon" P2) (id [#])) 
//                (pair (id "SideMover" P1) (id "FreeBoar" P1)) (pair (id "SideMover" P2) (id "FreeBoar" P2)) 
//                (pair (id "VerticalMover" P1) (id "FlyingGox" P1)) (pair (id "VerticalMover" P2) (id "FlyingGox" P2)) 
//                (pair (id "Bishop" P1) (id "DragonHorse" P1)) (pair (id "Bishop" P2) (id "DragonHorse" P2)) 
//                (pair (id "DragonHorse" P1) (id "HornedFalcon" P1)) (pair (id "DragonHorse" P2) (id "HornedFalcon" P2)) 
//                (pair (id "DragonKing" P1) (id "SoaringEagle" P1)) (pair (id "DragonKing" P2) (id "SoaringEagle" P2))    
//                (pair (id "Chunin" P1) (id "Suizo" P1)) (pair (id "Chunin" P2) (id "Suizo" P2)) 
            })
            
        })
            
            
        (rules
            (start {
            	(place "Lance1" {"A1" "Q1"}) 
                (place "Lance2" {"A17" "Q17"})
            })
            (play
                    (if ("SameTurn")
//                        (if (and (is Pending) (is In (what at:(last To)) (sites {(id "Lion" Mover)})))
//                            (forEach Piece {"Lion"}
//                                (or
//                                    ("HopMove" (directions All))
//                                    ("StepMove" (directions All))
//                                )
//                            ) 
                            (or
                                ("Promote")
                                (move Pass)
                            )
                      //  )
                        (do 
                            (forEach Piece) 
                            ifAfterwards:(not ("IsInCheck" "Lance" Mover))
                        )
                    )
                )
            (end {
                (if (and 
                        ("IsInCheck" "Lance" Next)
                        ("NextCannotMove")
                    ) 
                    (result Mover Win)
                ) 
            })
        )
        >
        "The incomplete ruleset."
    )
})

//------------------------------------------------------------------------------

(rulesets { 
    
    (ruleset "Ruleset/Historical Information (Incomplete)" {
        "Variant/Incomplete"
    })
    
})

//------------------------------------------------------------------------------

(metadata 
    
    (info
        {
        (description "Dai Dai Shogi is a large Shogi game known from at least the nineteenth century in Japan, but which may be older.")
        (rules "17x17 board. Pieces are as follows: Kyosha (x2): move any distance forward orthogonally, promotes to Hakku, which moves any distance forward or backward orthogonally or forward diagonally, places in the corners; Tengu (x1): moves any distance diagonally, palced next to left Kyosha; Yasha (x1): moves up to five spaces orthogonally or up to two spaces diagonally, placed next to Tengu; Sosha (x1): moves any distance orthogonally or one space backward diagonally, placed next to Yasha; Ryuma (x11): moves any distance diagonally or one space orthogonally, promotes to Kakuo which moves up to two spaces forward orthogonally or any distance in any other direction, placed next to Sosha; Honki (x1): moves any distance horizontally orthogonal or diagonally forward or up to five spaces orthogonally forward or back, placed next to Ryuma; Honno (x1): moves any distance in any direction, placed next to the Honki; Sasho (x1): moves one space in any direction except orthogonally to the left, placed next to Honno; Oshoa (x1): moves one space in any direction, placed next to Sasho; Usho (x1): moves one space in any direction except orthogonally to the right, placed next to Osho; Honbaku (x1): moves any distance diagonally forwad or orthogonally forward or backward or up to five spaces orthogonally horizontally, placed next to Usho; Ryuo (x1): moves any distance orthogonally or one space diagonally, promotes to Hiju which moves any distance orthogonally or up to two spaces forward diagonally, placed next to Honbaku; Hogyo (x1): moves any distance orthogonally or one space diagonally forward, placed next to Ryuo; Hishia (x1): moves orthogonally any distance, promotes to Ryuo, placed next to Hogyo; Kyuhan (x1): moves up to five spaces diagonally or up to two spaces orthogonally, placed next to Hisha; Kogyo (x1) moves any distance orthogonally, placed next to Kyuhan; Hensha (x2): moves any distance orthogonally forward or backward, promotes to Keigei which moves any distance orthogonally forward or diagonally backward, in front of Kyosha; Kotetsu (x1): moves any distance  forward diagonally or up to two spaces orthogonally, promoted to Tengu, placed next to left Hensha; Shishi (x1): moves one space in any direction, moves twice in one turn, or may jump to the second space, promotes to Funjin (unknown move), placed next to Kotetsu; Roso (x1): moves up to two spaces diagonally forward or orthogonally backwards, promoted piece moves any distance diagonally or one space backward orthogonally, placed next to Shishi; Yoroku (x1): moves up to two spaces orthogonally horizontal or one space in any other direction except backward, placed next to Roso; Myojin (x1): moves one space diagonally, placed next to Yoroku; Hoo (x1): jumps to the second square diagonally, promotes to Kirin, placed next to Myojin; Kinsho (x2): moves one space orthogonally or forward diagonally, promotes to Hisha, placed next to Hoo and Kinno; Kinno (x1): moves orthogonally in all directions, promotes to Zenki, placed between Kinsho, Kirin (x1): jumps orthogonally to the second square or moves one square diagonally, promotes to Dairyu, placed next to right Kinsho; Gyocho (x1): moves any distance in all directions except orthogonally backwards, promotes to Honki, placed next to Kirin; Hiryu (x1): moves up to two spaces diagonally, placed next to Gyocho; Moen (x1): moves one space diagonally or horizontal orthogonally, promotes to Sambo which moves any distance diagonally or orthogonally backwards or forward, placed next to Hiryu; Komainu (x1): moves up to three spaces in any direction, placed next to Moen; Dokuja (x1): jumps to the second space orthogonally forward or diagonally backward or moves one space horizontally orthogonal, placed next to Komainu; Shugyo (x1): moves any distance forward or backward orthogonally or one space horizontal orthogonally, placed next to Kotetsu; Henko (x1): moves up to two spaces diagonally forward or orthogonally backward, promotes to Yasha, placed in front of Roso; Suigyu (x1): moves any distance diagonally or orthogonally horizontal or up to two spaces orthogonally backward or forward, promotes to Honbaku, placed in front of Myojin; Ginsho (x2): moves one space diagonally or forward or backward orthogonally, promotes to Shugyo, placed in front of Ginsho; Dairyu (x1): moves up to two spaces orthogonally forward or backward, up to three spaces diagonally backward, or either any distance or up to three spaces horizontally orthogonal (unclear), placed in between Ginsho;Barin (x1): moves one space orthogonally or up to two spaces diagonally forward, promotes to Honno, placed in front of Gyocho; Henri (x1): moves orthogonally up to two spaces except backwards, promotes to Kyuhan, placed in front of Moen; Kakugyo (x1): moves any distance diagonally, promotes to Ryuma, placed in front of Dokuja; Seiryu (x1): moves any distance orthogonally horizontal or diagonally forward to the left or backward to the right or up to two spaces orthogonally forward or back or one space diagonally forward to the right, placed in the fourth row in front of the left Hensha; Kozo (x1): moves any distance diagonally forward or up to two spaces in any other direction, placed next to Seiryu; Hokuteki (x1): moves one space orthogonally horizontal or diagonally back or up to two spaces diagonally forward, placed next to Kozo, promotes to Kozo; Seiju (x1): moves up to two spaces orthogonally horizontal or one space orthogonally forward or backward, promotes to Komainu, placed next to Hokuteki; Mokusho (x2): moves up to two spaces diagonally forward, placed next to Sekisho; Sekisho (x2): moves one space diagonally forward, placed next to Tessho; Tessho (x2): moves forward orthogonally and diagonally, placed next to Sekisho, Dosho (x2): move one space forward orthogonally or diagonally or backward orthogonally, placed next to Kinshi; Kinshi (x1): moves any distance orthogonally forward or backward or up to three spaces diagonally or up to two spaces orthogonally horizontal, placed in the center of fourth row; Toi (x1): moves one space orthogonally to the left or up to two spaces forward or backward orthogonally, promotes to Shishi, placed in front of right Mokusho; Namban (x1): moves one space orthogonally to the left or up to two spaces diagonally backwards, promotes to Hakuzo, placed next to Toi; Hakuzo (x1): moves any distance diagonally backward or up to two spaces in all other directions except orthogonally backwards, placed next to Namban; Byajjo (x1): moves any distance orthogonally forwrd or back, diagonally forward to the right or one space diagnally back to the left or up to two sapces orthogonally horizontal, placed next to Hakuzo; Sasha (x1): moves any distance orthogonally forward or diagonally forward to the right or diagonally backward to the left or one space orthognally to the left, placed in front of Seiryu, Ogyo (x2): moves any distance orthogonally horizontal or one space orthogonally forward or back, promoted piece moves any distance in any direction except orthogonally forward, placed next to Sasha and Usha; Mogyu (x2): moves up to two spaces orthogonally, placed next to Ogyo; Shincho (x2): moves one space orthogonally, placed next to Mogyu; Akuro (x2): moves one space diagonally or orthogonally forward, placed next to Shincho; Moyu (x2): moves one space orthogonally horizontal or diagonally forward, placed next to Akuro; Mohyo (x2): moves one space forward or backward orthogonally or diagonally, promotes to Kakugyo, placed next to Moyu; Moko (x2): moves one space diagonally forward or up to two spaces forward or backward orthogonally, placed next to Mohyo; Zenki (x1): moves any distance forwrd orthogonally or diagonally, up to two spaces orthogonally horizontal or one space backward orthogonally or diagonally, placed next to Moko; Usha (x1): moves any distance forward orthogonally or diagonally forward left or diagonally backward right or one space horizontally to the right, palced next to right Ogyo; Fuhyo (x17): moves one space orthogonally forward, placed in sixth row; Kiken (x2): moves any distance orthogonally forward or one space orthogonally backward, placed in the sixth spaces from the left and right sides of the board.")
        (source "DLP evidence.")
        (id "1337")
        (version "1.3.10")
        (classification "board/war/replacement/checkmate/shogi/reconstruction/pending")
        (credit "Eric Piette")
        (origin "This game was played in Japan, around 1834.")
        }
    )
    
    (graphics {
        (player Colour P1 (colour White))
        (player Colour P2 (colour White))
        (piece Rotate P2 degrees:180)
        (board Style Shogi)
        (piece Style ExtendedShogi)
    })
    
)
