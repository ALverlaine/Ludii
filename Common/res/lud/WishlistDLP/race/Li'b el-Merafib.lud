(define "InitSite" 73)

(define "ThrowValue" (mapEntry "Throw" (count Pips)))

(define "ThrowOf1" (= ("ThrowValue") 1))
(define "ThrowOf2" (= ("ThrowValue") 2))

(define "SiteToMoveOnTrack" (trackSite Move #1 #2 steps:#3))

(define "Tabulated"
	(if (is Mover P1)
		(remember Value "TabulatedP1" #1)
		(if (is Mover P2)
			(remember Value "TabulatedP2" #1)
			(if (is Mover P3)
				(remember Value "TabulatedP3" #1)
				(if (is Mover P4)
					(remember Value "TabulatedP4" #1)
					(if (is Mover P5)
						(remember Value "TabulatedP5" #1)
						(if (is Mover P6)
							(remember Value "TabulatedP6" #1)
							(if (is Mover P7)
								(remember Value "TabulatedP7" #1)
								(remember Value "TabulatedP8" #1)
							)
						)
					)
				)
			)
		)
	)
)

//------------------------------------------------------------------------------

(game "Li'b el-Merafib"
    (players <Player:num>)
    (equipment {
        (board 
            (merge {
                (shift 4 4 (rectangle 2 1))
                (shift 4 4 (rectangle 1 4))
                (shift 7 4 (rectangle 4 1))
                (shift 2 7 (rectangle 1 6))
                (shift 2 2 (rectangle 6 1))
                (shift 2 2 (rectangle 1 8))
                (shift 9 2 (rectangle 8 1))
                (shift 0 9 (rectangle 1 10))
                (rectangle 10 1)
                (rectangle 1 12)
                (shift 11 0 (rectangle 12 1))
                (shift 0 11 (rectangle 1 12))
            })
            {
            (track "Track" "73,E,S,W,N,E,S,W,N,E,S,W,N" directed:True)
            (track "ReverseTrack" "2,S,E,N,W,S,E,N,W,S,E,N,W" directed:True)
            }
        )
        (dice d:2 from:0 num:3)
        (piece "Stick" Each
            (if (= (from) ("InitSite"))
                (move
                    (from (from) level:(level)
                        if:("ThrowOf1")
                    )
                    (to 
                        ("SiteToMoveOnTrack" from:(from) "Track" ("ThrowValue"))
                    )
                )
                (if (not ("ThrowOf1"))
                    (move
                        (from (from) level:(level))
                        (to 
                            ("SiteToMoveOnTrack" from:(from) "Track" ("ThrowValue"))
                        )
                    )
                    (move Pass
                    	(then ("Tabulated" ("ThrowValue")))
                    )
                )
            )
        )
        (piece "Hyena" Each)
        (map "Throw" {(pair 0 6) (pair 1 1) (pair 2 2) (pair 3 4)})
    })
    (rules 
        (start {
            <Player:start>
        })
        (play 
            (do (roll) 
                next:(forEach Piece)
                (then
                        (if (not ("ThrowOf2"))
                            (moveAgain)
                        )
                    )
            )
        )
        (end (if (no Moves Next) (result Mover Win)))
    )
)

//------------------------------------------------------------------------------

(option "Players" <Player> args:{ <num> <start>}
    {
    (item "2" <2>
        <
        (place Stack items:{"Stick2" "Stick1"} "InitSite")
        >
    "The game has 2 players.")   
    (item "3" <3>  
        <
        (place Stack items:{"Stick3" "Stick2" "Stick1"} "InitSite")
        >
    "The game has 3 players.")  
    (item "4" <4>  
        <
        (place Stack items:{"Stick4" "Stick3" "Stick2" "Stick1"} "InitSite")
        >
    "The game has 4 players.")*  
    (item "5" <5>  
        <
        (place Stack items:{"Stick5" "Stick4" "Stick3" "Stick2" "Stick1"} "InitSite")
        >
    "The game has 5 players.")  
    (item "6" <6>  
        <
        (place Stack items:{"Stick6" "Stick5" "Stick4" "Stick3" "Stick2" "Stick1"} "InitSite")
        >
    "The game has 6 players.")  
    (item "7" <7>  
        <
        (place Stack items:{"Stick7" "Stick6" "Stick5" "Stick4" "Stick3" "Stick2" "Stick1"} "InitSite")
        >
    "The game has 7 players.")  
    (item "8" <8>  
        <
        (place Stack items:{"Stick8" "Stick7" "Stick6" "Stick5" "Stick4" "Stick3" "Stick2" "Stick1"} "InitSite")
        >
    "The game has 8 players.")  
})

//------------------------------------------------------------------------------

(metadata 
    
    (info
        {
        (description "Li'b el-Merafib is a race game played by the Kababish peopl of Sudan. The pieces represent the players' mothers, traveling from their home village to a well to get water, and they have to race home to avoid being eaten by the hyena, which eliminates players it overtakes.")
        (aliases {"Hyena Game"})
        (rules "The board is a square spiral of any number of spaces. Each player begins with one piece. Three casting sticks, each with a round and a flat side, are used as dice. The throws are as follows: One flat side up = 1; two flat sides up = 2; three flat sides up = 4, zero flat sides up = 6. The pieces begin on the outer end of the track, and must throw a 1 to begin play. Once a player has left the starting spot, they move according to the throws, except on throws of 1, which are tabulated for use later. Players continue to throw until they throw 2. Players must land on the last space of the track, I.e. at the center of the spiral, by an exact throw, and may use one of their accumulated throws of 1 if a 1 is required. The player must then roll 1 five times before leaving this space and proceeding back to the starting point. Accumulated rolls of 1 may be used for this. If the player must wait, they may accumulate individual throws of 2, 4, or 6 to use later. The first player to reach the starting space by an exact throw releases the hyena, which cannot move until 1 is thrown twice, or paid from the accumulated throws. The hyena proceeds along the track in the same manner, but moving twice the value of each throw. When the hyena reaches the end of the track, it must throw or pay 1 ten times. The hyena captures any piece it overtakes on the return to the starting space, eliminating that player from the game.")
        (source "Davies 1925: 145-146.")
        (version "1.2.1")
        (classification "race/WishlistDLP")
        (credit "Eric Piette")
        (origin  "This game was played in Sudan, around 1925.")
        }
    )
    
    (graphics {
        (board Colour Phase0 (colour 223 178 110))
        (board Colour InnerEdges (colour Black))
        (board Colour OuterEdges (colour Black))
        (stackType 0 Ground)
        (piece Scale "Stick" 0.5)
        (piece Scale "Hyena" 0.5)
        (piece Rename piece:"Hyena" "Marker")
    })
    
)

