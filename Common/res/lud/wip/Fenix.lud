(define "NoKing" 
	(all Sites (sites Occupied by:Mover) if:(!= 3 (size Stack at:(site))))
)

(define "DoesNotHaveThreeGeneral" 
	(!= 3 (count Sites in:(forEach (sites Occupied by:Mover) if:(= 2 (size Stack at:(site))))))
)

//------------------------------------------------------------------------------

(game "Fenix"
	(players 2)
	(equipment {
		(board <Board:board>)
		(piece "Fenix" Each (move Step (to if:(is Empty (to))) stack:True))
	})
	(rules
		(start {
			(place "Fenix1" (expand (intersection (sites Bottom) (sites Right)) steps:<Board:expandSize> Orthogonal))
			(place "Fenix2" (expand (intersection (sites Top) (sites Left)) steps:<Board:expandSize> Orthogonal))
		})
		
		phases:{
			(phase "Setup"
				(play 
					(move
						(from (sites Occupied by:Mover) if:(= 1 (size Stack at:(from))))
						(to 
							(sites Occupied by:Mover) 
							if:(and {
									(!= (from) (to))
									(< (size Stack at:(to)) 3)
									(if ("NoKing")
										True
										(< (size Stack at:(to)) 2)
									)
									(if ("DoesNotHaveThreeGeneral")
										True
										(!= (size Stack at:(to)) 1)
									)
							})
						)
						stack:True
					)
				)
				(nextPhase Mover (and (not ("NoKing")) (not ("DoesNotHaveThreeGeneral"))) "Play")
			)
			(phase "Play"
				(play (forEach Piece))
			)
		}
		
	)
)

//------------------------------------------------------------------------------

(option "Board" <Board> args:{ <board> <expandSize> }
  {
  (item "9x9" <(square 9)> <6> "The game is played on a 9x9 square board.")
  (item "7x8" <(rectangle 7 8)> <5> "The game is played on a 7x8 square board.")
})

//------------------------------------------------------------------------------

(metadata 
	(graphics {
        (player Colour P1 (colour VeryDarkGrey))
        (player Colour P2 (colour Red))
        (piece Rename piece:"Fenix" "Eagle")
        (piece Background "Fenix1" image:"disc" fillColour:(colour Red))
        (piece Background "Fenix2" image:"disc" fillColour:(colour VeryDarkGrey))
        (board Colour InnerEdges (colour Black))
        (board Colour OuterEdges (colour Black))
        (board Colour Phase0 (colour Orange))
	})
)