// Checkmate detection is broken
// exact is not working
// pieces always can move minimum of 2

(define "Move"
    (move 
        (from 
            (from)
        ) 
        (to 
        	(union
                (sites Around
                    (sites Distance 
                        (step
                            Orthogonal
                            (to if:(is Empty (to)))
                        ) 
                        from:(from) 
                        (range 0 (value Piece at:(from)))
                    )
                    Orthogonal
                )
                (sites Around (from) Orthogonal)
            )
            if:"KingNotCheckedAndToNotFriend" 
            (apply 
                (set Value at:(from) (value Random (range 1 #1)))
            ) 
        )
    )
)

(define "KingNotCheckedAndToNotFriend"
    (and 
        (not (is Friend (who at:(to))))
        (not ("IsInCheck" "King" Mover)) 
    )   
)

(define "NextCanNotMove"
    (not (can Move (do (forEach Piece Next) ifAfterwards:(not ("IsInCheck" "King" Next)))) )
)

//------------------------------------------------------------------------------

(game "Shogun"  
    (players {(player N) (player S)})  
    (equipment { 
        (board (square 8)) 
        
        (piece "Pawn" Each 
            ("Move" 4)
        )
        
        (piece "King" Each 
             ("Move" 2)
        )
    })  
    (rules 
        (start { 
            (place "Pawn1" coord:"A1" value:(value Random (range 1 4)))
            (place "Pawn1" coord:"B1" value:(value Random (range 1 4)))
            (place "Pawn1" coord:"C1" value:(value Random (range 1 4)))
            (place "Pawn1" coord:"D1" value:(value Random (range 1 4)))
            (place "Pawn1" coord:"F1" value:(value Random (range 1 4)))
            (place "Pawn1" coord:"G1" value:(value Random (range 1 4)))
            (place "Pawn1" coord:"H1" value:(value Random (range 1 4)))
            (place "King1" coord:"E1" value:(value Random (range 1 2))) 
            (place "Pawn2" coord:"A8" value:(value Random (range 1 4)))
            (place "Pawn2" coord:"B8" value:(value Random (range 1 4)))
            (place "Pawn2" coord:"C8" value:(value Random (range 1 4)))
            (place "Pawn2" coord:"E8" value:(value Random (range 1 4)))
            (place "Pawn2" coord:"F8" value:(value Random (range 1 4)))
            (place "Pawn2" coord:"G8" value:(value Random (range 1 4)))
            (place "Pawn2" coord:"H8" value:(value Random (range 1 4)))
            (place "King2" coord:"D8" value:(value Random (range 1 2))) 
        })
        
        (play 
            (forEach Piece)
        )
        
        (end {
            (if (or
	            	(and 
	                    ("IsInCheck" "King" Next)
	                    ("NextCanNotMove")
	                ) 
	                (<= (count Pieces Next) 2)
	            )
                (result Mover Win)
            ) 
            (if (or (no Moves Mover) (= (counter) 99)) (result Mover Draw)) 
        })
    )
)

//------------------------------------------------------------------------------

(metadata 
    
    (info
        {
        (credit "Matthew Stephenson")
        }
    )
    
    (graphics {
        (show Check "King")
        (piece Scale "Pawn" 0.825)
        (piece Families {"Defined" "Microsoft" "Pragmata" "Symbola"})
        (board Style Chess)
        (show Piece Value valueOutline:true)
    })
    
    (ai 
        "Shogun_ai"
    )
    
)
